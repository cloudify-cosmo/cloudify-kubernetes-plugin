tosca_definitions_version: cloudify_dsl_1_3

description: >
  This runs a trivial deployment in kubernetes.
  Expects that you have first installed https://github.com/cloudify-examples/simple-kubernetes-blueprint/tree/4.0.1.
  Also install the wagon with the command: "cfy plugins upload PATH_TO_WAGON".

imports:
  - http://www.getcloudify.org/spec/cloudify/5.0.5/types.yaml
  - plugin:cloudify-kubernetes-plugin?version= >=2.7.1
  - plugin:cloudify-openstack-plugin


inputs:

  configuration_file_content:
    type: string

  spec_port:
    default: 8000

  target_port:
    default: 80

  container_port:
    default: 80

dsl_definitions:

  openstack_config: &openstack_config
    username: { get_secret: keystone_username }
    password: { get_secret: keystone_password }
    project_name: { get_secret: keystone_tenant_name }
    auth_url: { get_secret: keystone_url }
    region_name: { get_secret: region }

node_templates:

  kubernetes_master:
    type: cloudify.kubernetes.nodes.Master
    properties:
      configuration: &master_configuration
        file_content: { get_input: configuration_file_content }

  persistent_volume:
    type: cloudify.kubernetes.resources.PersistentVolume
    properties:
      client_config:
        configuration: *master_configuration
      definition:
        apiVersion: v1
        metadata:
          name: pv0003
        spec:
          capacity:
            storage: 5Gi
          accessModes:
            - ReadWriteOnce
          persistentVolumeReclaimPolicy: Recycle
          storageClassName: gold
          cinder:
            volumeID: { get_attribute: [openstack_volume, id] }
    relationships:
      - type: cloudify.relationships.depends_on
        target: example_storage
      - type: cloudify.relationships.depends_on
        target: openstack_volume
      - type: cloudify.relationships.depends_on
        target: kubernetes_master

  openstack_volume:
    type: cloudify.nodes.openstack.Volume
    properties:
      client_config: *openstack_config
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            args:
              size: 10

  example_storage:
    type: cloudify.kubernetes.resources.StorageClass
    properties:
      client_config:
        configuration: *master_configuration
      definition:
        apiVersion: storage.k8s.io/v1beta1
        metadata:
          name: gold
        provisioner: kubernetes.io/cinder
        parameters:
          type: fast
          availability: nova
    relationships:
      - type: cloudify.relationships.depends_on
        target: kubernetes_master
